<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="Generator" content="xnr®">
    <meta name="Author" content="小男人-923227829@qq.com">
    <meta name="Keywords" content="">
    <meta name="Description" content="">
    <title>设置服务者</title>
    <link rel="stylesheet" href="../inc/layui/css/layui.css">
    <link rel="stylesheet" href="../css/comm.css" />
    <style>
    </style>
</head>

<body>
    <div id="form" class="layui-form" style="margin-top: 20px;width: 80%;">
        <input type="hidden" name="userid" id="userid" />
        <div class="layui-form-item">
            <label class="layui-form-label">服务者类型</label>
            <div class="layui-input-inline" id="type">

            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">服务者</label>
            <div class="layui-input-inline">
                <input value="" type="text" name="name" lay-verify="required" id="name" autocomplete="off" placeholder="请输入服务者名称" class="layui-input"
                />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">服务名称</label>
            <div class="layui-input-block">
                <input value="" type="text" name="title" lay-verify="required" id="title" autocomplete="off" placeholder="请输入服务名称" class="layui-input"
                />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">单选框</label>
            <div class="layui-input-block">
                <input type="radio" name="sex" value="男" title="男" checked="">
                <input type="radio" name="sex" value="女" title="女">
                <input type="radio" name="sex" value="禁" title="禁用" disabled="">
            </div>
        </div>
        <div class="layui-form-item ">
            <label class="layui-form-label">上传图片</label>
            <div class="layui-input-block">
                <div class="layui-upload">
                    <button type="button" class="layui-btn" id="btnimg">上传图片</button>
                    <div class="layui-upload-list">
                        <div id="uploadimg">

                        </div>
                        <br>
                        <span class="f12">建议：400px*400px，1M以内</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item ">
            <label class="layui-form-label">多图上传</label>
            <div class="layui-input-block">
                <div class="layui-upload">
                    <button type="button" class="layui-btn" id="btnimg1">上传图片</button>
                    <div class="layui-upload-list">
                        <div id="uploadimg1">

                        </div>
                        <br>
                        <span class="f12">建议：400px*400px，1M以内</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item tagall">
            <label class="layui-form-label">服务标签</label>
            <div class="layui-input-block">
                <input value="" type="text" name="tags" lay-verify="required" id="tags" autocomplete="off" placeholder="请输入服务标签" class="layui-input layui-input-inline"
                />
                <button class="layui-btn layui-btn-danger addtag">新增</button>
            </div>
            <div id="addtag">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-row">
                <div class="layui-col-xs4">
                    <label class="layui-form-label">20分钟价格</label>
                    <div class="layui-input-block">
                        <input value="" type="number" name="m20" lay-verify="required" id="m20" autocomplete="off" placeholder="请输入20分钟价格" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <label class="layui-form-label">40分钟价格</label>
                    <div class="layui-input-block">
                        <input value="" type="number" name="m40" lay-verify="required" id="m40" autocomplete="off" placeholder="请输入40分钟价格" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <label class="layui-form-label">80分钟价格</label>
                    <div class="layui-input-block">
                        <input value="" type="number" name="m80" lay-verify="required" id="m80" autocomplete="off" placeholder="请输入80分钟价格" class="layui-input">
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-row">
                <div class="layui-col-xs4">
                    <label class="layui-form-label">1小时价格</label>
                    <div class="layui-input-block">
                        <input value="" type="number" name="m60" lay-verify="required" id="m60" autocomplete="off" placeholder="请输入1小时价格" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <label class="layui-form-label">两小时价格</label>
                    <div class="layui-input-block">
                        <input value="" type="number" name="m120" lay-verify="required" id="m120" autocomplete="off" placeholder="请输入两小时价格" class="layui-input">
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-row">
                <div class="layui-col-xs4">
                    <label class="layui-form-label">选择地址</label>
                    <div class="layui-input-block">
                        <select name="province" lay-filter="province" id="province" lay-verify="required">
                            <option></option>
                        </select>
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <div class="layui-input-block">
                        <select name="city" lay-filter="city" id="city" lay-verify="required">
                            <option></option>
                        </select>
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <div class="layui-input-block">
                        <select name="area" lay-filter="area" id="area" lay-verify="required">
                            <option></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-row">
                <div class="layui-col-xs4">
                    <label class="layui-form-label">分类</label>
                    <div class="layui-input-block">
                        <select name="s1" lay-filter="s1" id="s1" lay-verify="required">
                            <option></option>
                        </select>
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <div class="layui-input-block">
                        <select name="c2" lay-filter="c2" id="c2" lay-verify="required">
                            <option></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">选择地址</label>
            <div class="layui-input-block">
                <input value="" type="text" name="addr" lay-verify="required" id="addr" autocomplete="off" class="layui-input" />
                <div id="map" style="height:300px;width:100%;margin-top:10px;"></div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea id="ds" name="ds" style="height:100px;width: 100%;padding: 10px;box-sizing: border-box;"></textarea>
                <br>
                <span>最多500字</span>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">图文详情</label>
            <div class="layui-input-block">
                <div id="edit" style="height:400px;width: 100%"></div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <div class="layui-input-inline">
                <button class="layui-btn layui-btn-danger" lay-submit="" lay-filter="subbtn">保存</button>
                <button class="layui-btn layui-btn-primary" id="closeform">关闭</button>
            </div>
        </div>
    </div>
</body>

<script type="text/html" id="typeTpl">
    {{#  layui.each(d, function(i, e){ }}
        {{#  if(d.type&&d.type.indexOf(e.dictid)>=0){ }}
        <input type="checkbox" name="type" title="{{e.dictname}}" value="{{e.dictid}}" lay-skin="primary" checked/>
        {{#  } else { }}
        <input type="checkbox" name="type" title="{{e.dictname}}" value="{{e.dictid}}" lay-skin="primary"/>
        {{#  } }}
    {{#  }); }}
</script>
<script type="text/html" id="tagTpl">
    <div style="margin-top:10px;">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
            <input value="{{d.name?d.name:''}}" type="text" name="" lay-verify="required" id="" autocomplete="off" placeholder="请输入服务标签" class="layui-input layui-input-inline" />
            <button value="{{d.name?d.name:''}" class="layui-btn layui-btn-sm layui-btn-primary deltag" onclick="extp.deltag(this)">删除</button>
        </div>
    </div>
</script>
<script type="text/javascript" src="../inc/g.js"></script>
<script type="text/javascript" src="../inc/dict.js"></script>
<script src="http://api.map.baidu.com/api?v=2.0&ak=R0d1Iv4YdniK8MUN4snaMZKRAGnI5TGW"></script>
<script type="text/javascript" src="../inc/layui/layui.js"></script>
<script type="text/javascript" src="../inc/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="../inc/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" src="../inc/area.js"></script>

<script type="text/javascript">


    var top_right_navigation = new BMap.NavigationControl({ anchor: BMAP_ANCHOR_TOP_RIGHT }); //右上角，仅包含平移和缩放按钮
    var map = null, geoc = null, mapinfo = null;
    function mapinit() {
        map = new BMap.Map("map"); // 创建地图实例30.626124, longitude: 104.03797
        //map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);
        var newpoint = new BMap.Point(104.03797, 30.626124);
        map.centerAndZoom(newpoint, 15);
        var marker = new BMap.Marker(newpoint);// 创建标注
        map.addOverlay(marker);
        marker.disableDragging();
        geoc = new BMap.Geocoder();
        map.addControl(top_right_navigation);


        map.addEventListener("dragend", function (e) {
            map.clearOverlays();
            var centerpoint = e.target.getCenter();
            var marker = new BMap.Marker(centerpoint);// 创建标注
            map.addOverlay(marker);
            marker.disableDragging();

            getaddr(centerpoint)
        })
        map.addEventListener("click", function (e) {
            map.clearOverlays();
            var newpoint = new BMap.Point(e.point.lng, e.point.lat);
            var marker = new BMap.Marker(newpoint);// 创建标注
            map.addOverlay(marker);
            marker.disableDragging();

            getaddr(newpoint)
        })


        new BMap.Geolocation().getCurrentPosition(function (r) {
            Comm.g("addr").value = r.address.city;

            if (this.getStatus() == BMAP_STATUS_SUCCESS) {

                var newpoint = new BMap.Point(r.point.lng, r.point.lat);
                map.centerAndZoom(newpoint, 15);

                map.clearOverlays();
                var marker = new BMap.Marker(newpoint);// 创建标注
                map.addOverlay(marker);
                marker.disableDragging();

                getaddr(newpoint)
            } else {
                Comm.msg("定位失败，请打开GPS或检查权限后重试", 5);
            }
        });
    }

    function getaddr(point) {
        geoc.getLocation(point, function (rs) {
            if (rs) {
                mapinfo = rs.point;
                Comm.g("addr").value = rs.address;
            }
        });
    }


    var wxuserId = Comm.query("id");
    var extp = {};
    //加载页面
    function pageload() {
        //初始化上传控件
        Comm.upload.render({
            elem: '#btnimg', //绑定元素
            field: 'file',
            accept: 'images',
            acceptMime: 'image/jpg,image/png,image/JPEG',
            multiple: false,//单图
            url: config.ossroot,
            before: function (obj, o) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                //上传loading
                layer.load();
            },
            done: function (d) {
                layer.closeAll('loading'); //关闭loading
                top.Comm.OSS.inithtml(this.data, function (html) {
                    $('#uploadimg').html(html);
                })
            },
            error: function () {
                //请求异常回调
                layer.closeAll('loading'); //关闭loading
            }
        });
        //多图片上传
        Comm.upload.render({
            elem: '#btnimg1',
            field: 'file',
            accept: 'images',
            acceptMime: 'image/jpg,image/png,image/JPEG',
            multiple: true,//多图
            number: 2,
            url: config.ossroot,
            before: function (obj) {
                //上传loading
                layer.load();
            },
            done: function (d) {
                layer.closeAll('loading'); //关闭loading
                top.Comm.OSS.inithtml(this.data, function (html) {
                    $('#uploadimg1').append(html);
                })
            },
            error: function () {
                //请求异常回调
                layer.closeAll('loading'); //关闭loading
            }
        });

        //初始化地图
        mapinit();

        //初始化编辑器
        UE.delEditor('edit');
        var ue = UE.getEditor('edit');

        //引用加载省市区
        layui.extend({
            pca: '../../inc/layui/lay/pca'
        })
        layui.use(['pca'], function () {
            Comm.pca = layui.pca;
            //初始地区
            Area.init(function () {

                Comm.pca.init('select[name=province]', 'select[name=city]', 'select[name=area]', _area, 110000, 110100, 110105);
                //不带初始值
                //pca.init('select[name=province]', 'select[name=city]', 'select[name=area]');
                //地区取值
                var a = Area.getArea(110000)
                var b = Area.getArea(110105)

            })

            //多级分类处理结构
            var data = [{
                p: 0, i: 1, s: '1级', c: [{ p: 1, i: 11, s: '1.11级' }, { p: 1, i: 12, s: '1.12级' }]
            }, {
                p: 0, i: 2, s: '2级', c: [{ p: 2, i: 21, s: '2.21级' }, { p: 2, i: 22, s: '2.22级' }]
            }]
            Comm.pca.init('select[name=s1]', 'select[name=c2]', '', data, 1, 12);

        })


        GDict.init(function () {
            var d = GDict.get("bank");
            //如果id不等于空表示编辑
            if (wxuserId !== '') {
                //请求AJAX填充数据
                AJAX.GET("api/buser/item?userid=" + wxuserId, function (a) {
                    if (a.code == 1) {
                        //绑定分类checkbox
                        d.type = a.data.type;
                        Comm.laytpl($("#typeTpl").html()).render(d, function (html) {
                            $("#type").html(html);
                            //初始化checkbox 控件
                            Comm.form.render();
                        })
                        //绑定值
                        Comm.SetData(a.data, 'form')
                        //绑定编辑器值
                        ue.ready(function () {
                            ue.setContent(a.data.ds);
                        })
                    }
                })
            } else {
                //绑定分类
                d.type = '';
                Comm.laytpl($("#typeTpl").html()).render(d, function (html) {
                    $("#type").html(html);
                    //初始化checkbox 控件
                    Comm.form.render();
                })
            }
        })
        //验证空必填项
        Comm.form.verify();

        $(".addtag").click(function () {
            var d = {};
            Comm.laytpl($("#tagTpl").html()).render(d, function (html) {
                $("#addtag").append(html)
            })
        })

        //表单提交
        Comm.form.on('submit(subbtn)', function (data) {

            //标签
            var tag = [];
            $(".tagall input").each(function (i, e) {
                tag.push($(e).val())
            })
            data.field.tags = tag.join(",");

            //地图
            data.field.mapinfo = mapinfo.lng + "," + mapinfo.lat;
            //默认值
            data.field.enable = 1
            //编辑器获取值
            data.field.edit = UE.getEditor('edit').getContent();

            //获取分类checkbox 取值
            var types = [];
            $("input:checkbox[name='type']:checked").each(function () { // 遍历name=standard的多选框
                types.push($(this).val())
            });
            data.field.type = types.join(",")

            if (types.length == 0) {
                layer.msg("请至少选择一个分类!", { icon: 5 })
                return
            }
            //单图取值
            data.field.face = $("#uploadimg img").attr("data");
            if (data.field.face == "") {
                layer.msg("请上传图片!", { icon: 5 })
                return
            }

            //单图多图取值
            data.field.faces = [];
            $("#uploadimg img").each(function (i, e) {
                data.field.faces.push($(e).attr("data"))
            })
            if (data.field.faces.length == 0) {
                layer.msg("多图请上传图片!", { icon: 5 })
                return
            }
            data.field.faces = data.field.faces.join(',')

            if (data.field.ds.length > 500) {
                layer.msg("描述最多500字!", { icon: 5 })
                return
            }

            Comm.confirm("设置成服务者", function () {
                AJAX.POST('admin/buser/add', data.field, function (d) {
                    if (d.code == 1) {
                        layer.msg("设置成功!", { icon: 1 })
                        //关闭当前选项卡第一个参数是选项卡的名称，跟添加是对应，第二个参数如果为true会刷新上一个选项卡的列表页
                        parent.cms.deltab("add", true);
                    } else {
                        layer.msg(d.msg, { icon: 5 })
                    }
                })
            })
        });
        $("#closeform").click(function () {
            //关闭当前选项卡第一个参数是选项卡的名称，跟添加是对应，第二个参数如果为true会刷新上一个选项卡的列表页,不填写也是 不刷新
            parent.cms.deltab("add");
        })

        extp.deltag = function (a) {
            $(a).parent().parent().remove();
        }
    }

</script>

</html>